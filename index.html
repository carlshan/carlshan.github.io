<!DOCTYPE html>
<meta charset="utf-8">
<meta title="Final Project: What's Up With California School Funding?">
<style>
    /* Styling for the Chart 1 Date Slider
    Taken from Jane Pong's example: https://bl.ocks.org/officeofjane/9b9e606e9876e34385cc4aeab188ed73
    */
    .selection-state {
      display: none;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: ew-resize; /* Other cursor properties: https://www.w3schools.com/csSref/pr_class_cursor.asp */
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }

    .selected {
        fill: steelblue
    }
</style>
<body>
    <!-- Importing D3 version 6 -->
    <script src="https://d3js.org/d3.v6.min.js"> </script>
    <h1>California's History of School Funding</h1>
    <p><strong>Author:</strong> Carl Shan</p>
    <p>As a former high school teacher who also spent his elementary, middle, high-school and college years in California public education institutions, I've always been very interested in the topic of California state education funding.</p>
    <p>In this article, I'll explore the history of school funding in California. Through it, we'll discover that California has been woefully underfunding its schools for a long time. A series of policy decisions has led to this outcome, and while there have been initiatives to address the funding gap, the state is still far from meeting it's duty to students.</p>
    <h2>So, how much does <span style="color: steelblue"><b>California</b></span> spend on its kids?</h2>
    <p>Let's start off by understanding just how much money <span style="color: steelblue"><b>California</b></span> has spent on its students. Below is the inflation-adjusted per-student spending of each of the 50 states (plus D.C.) since 1970. Press "Play" and to see how each state has risen and fallen over time.</p>
    <p>I've also plotted the median per-student spending in <span style="color:forestgreen"><b>green</b></span>, so you can see how <span style="color: steelblue"><b>California</b></span> stacks up against the other states.</p>
    <p>You can also hover over each state to see what it is. Feel free to select a comparison state from the dropdown below as well.</p>
    <p></p>

    <div id="chart1">
        <button id="chart1-button"
                type=button
                style="margin-right: 0.4em; width: 5em;"
                name="chart1button"
        >
            Play
        </button>
        <div id="chart1-slider"></div>
        <form>
            <select id="chart1-comparison-state">
                <option selected="selected" class="selection-state" value="">Select a comparison state</option>
                <option value="Alabama">Alabama</option>
                <option value="Alaska">Alaska</option>
                <option value="Arizona">Arizona</option>
                <option value="Arkansas">Arkansas</option>
                <option value="Colorado">Colorado</option>
                <option value="Connecticut">Connecticut</option>
                <option value="Delaware">Delaware</option>
                <option value="District of Columbia">District of Columbia</option>
                <option value="Florida">Florida</option>
                <option value="Georgia">Georgia</option>
                <option value="Hawaii">Hawaii</option>
                <option value="Idaho">Idaho</option>
                <option value="Illinois">Illinois</option>
                <option value="Indiana">Indiana</option>
                <option value="Iowa">Iowa</option>
                <option value="Kansas">Kansas</option>
                <option value="Kentucky">Kentucky</option>
                <option value="Louisiana">Louisiana</option>
                <option value="Maine">Maine</option>
                <option value="Maryland">Maryland</option>
                <option value="Massachusetts">Massachusetts</option>
                <option value="Michigan">Michigan</option>
                <option value="Minnesota">Minnesota</option>
                <option value="Mississippi">Mississippi</option>
                <option value="Missouri">Missouri</option>
                <option value="Montana">Montana</option>
                <option value="Nebraska">Nebraska</option>
                <option value="Nevada">Nevada</option>
                <option value="New Hampshire">New Hampshire</option>
                <option value="New Jersey">New Jersey</option>
                <option value="New Mexico">New Mexico</option>
                <option value="New York">New York</option>
                <option value="North Carolina">North Carolina</option>
                <option value="North Dakota">North Dakota</option>
                <option value="Ohio">Ohio</option>
                <option value="Oklahoma">Oklahoma</option>
                <option value="Oregon">Oregon</option>
                <option value="Pennsylvania">Pennsylvania</option>
                <option value="Rhode Island">Rhode Island</option>
                <option value="South Carolina">South Carolina</option>
                <option value="South Dakota">South Dakota</option>
                <option value="Tennessee">Tennessee</option>
                <option value="Texas">Texas</option>
                <option value="Utah">Utah</option>
                <option value="Vermont">Vermont</option>
                <option value="Virginia">Virginia</option>
                <option value="Washington">Washington</option>
                <option value="West Virginia">West Virginia</option>
                <option value="Wisconsin">Wisconsin</option>
                <option value="Wyoming">Wyoming</option>
            </select>
         </form>
    </div>
    <p>At first glance, not too shabby right? California seems to hover around the median most of the time, although there appears to be a dip in the '90s.</p>
    <p>If you watch carefully, you can also see a large near-universal drop in per-student spending in 2008 due to the Great Recession.</p>
    <h2>But wait ... what about each state's income?</h2>
    <p> It's tempting to stop the story here. You may be left with the impression that California's spending is mostly "meh". Not great, but also not terrible.</p>
    <p>You'd be wrong.</p>
    <p>One additional factor we need to consider is the wealth per state. Californians hear all the time about how, if they were a country, they would have the fourth-largest GDP in the world. Well, if that's the case then we should have higher expectations of California than other states. If it's bringing in the money, shouldn't it also be funding its schools more than the average state?</p>
    <p>The chart below examines this exact situation. </p>
    <p>Picture in your head if California (and all the other states) was a person. If you're picturing some hippie surfer, that's close enough. Let's call this person Mr. California</p>
    <p>Let's say that Mr. California makes an annual salary equal to the actual income of the average Californian. In 2016, that would roughly come out to $60,300.</p>
    <p>Now, let's say that Mr. California a child. Let's call her Lady Angeles. Unlike her dad, who she views as a bit of a bum, she aspires to be an actress and singer. And failing that, she'd settle for being a software engineer.</p>
    <p>In a typical year, how much money does Mr. California spend on educating his daughter? And how does Mr. California Stack up against Mrs. Delaware, Ms. Texas, Mr. Ohio and the other residents of the United States?</p>
    <p>In the graph below, I've calculated the percentage of each state's annual income that goes towards educating its kids. In doing so, I've also ranked each state, with <span style="color: steelblue"><b>California</b></span> in blue.</p>
    <p>Press "Play" and see how Mr. California stacks up now, adjusting each state for their annual income.</p>
    <div id="chart2">

    </div>
    <button id="chart2-button"
    type=button
    style="margin-right: 0.4em; width: 5em;"
    name="chart1button"
        >
            Play
    </button>
    <div id="chart2-slider"></div>
    <div id="chart3">
        <p>
            Woah. As you can see in both the interactive chart above, as well as the one below, a pretty different picture emerges than when we looked at things in the first chart. Rather than seeing California as mostly "meh", it looks like his daughter is right: he is a bum! Despite having the world's fourth largest GDP, Mr. California spends only a smaller percentage of that on educating his kids, when compared to the other states.
        </p>
        <p>Why is that? Well, it's complicated. There have been a lot of California policies that have affected state spending.</p>
        <p> In the chart below, try hovering over some key years and reading about the events that affected California's school funding. </p>
    </div>
        <p> (Note: You can also press "Play" on the button for the second chart and see how it affects this chart.)</p>
    <div id="chart3-explainer">
        <p> <em>{ Hover over the chart above to see this text update. }</em></p>
    </div>
    <p>Each of the policies or events that occurred on the dates in the chart above had an impact on California. Hovering over the year will allow you to read a little bit about each event. Each one could merit a whole essay deconstructing the impact it's had, but rather than spending the rest of this article explaining them, I'll direct you to a nifty explainer that's already been created to help you understand California's underfunding of its education system.</p>

    <h2>Continue reading ... </h2>
    <p>Ed100, a non-profit, non-partisan website created to freely educate students, parents and citizens on California's funding situation has done a great series of explainers on many of the policy events above.
    </p>
    <p>
        I encourage you <a href='https://ed100.org/lessons/californiaskimps'>continue reading on their website.</a>
    </p>

    <h3>Acknowledgements</h3>
    <p>Data source:
        <a href="https://docs.google.com/spreadsheets/d/1h8AmjqHZIA0P_hBxqFZYN7cgefEzlfY4TyxVHJXJbTs/edit#gid=505704472">here</a>
    </p>
    <p>Various ObservableHQ notebooks I used as inspiration and adapted code from, including ones by Mike Bostock, Jeff Heer and others.</p>


</body>
<script>
    // Variables for formatting the plot sizes
    let orange = '#bf7a1a'
    let margins = {
        top: 20,
        right: 100,
        bottom: 75,
        left: 50
    }

    let width = 1250; // width of plot
    let height = 500;

    let states = ['Alabama',
                    'Alaska',
                    'Arizona',
                    'Arkansas',
                    'Colorado',
                    'Connecticut',
                    'Delaware',
                    'District of Columbia',
                    'Florida',
                    'Georgia',
                    'Hawaii',
                    'Idaho',
                    'Illinois',
                    'Indiana',
                    'Iowa',
                    'Kansas',
                    'Kentucky',
                    'Louisiana',
                    'Maine',
                    'Maryland',
                    'Massachusetts',
                    'Michigan',
                    'Minnesota',
                    'Mississippi',
                    'Missouri',
                    'Montana',
                    'Nebraska',
                    'Nevada',
                    'New Hampshire',
                    'New Jersey',
                    'New Mexico',
                    'New York',
                    'North Carolina',
                    'North Dakota',
                    'Ohio',
                    'Oklahoma',
                    'Oregon',
                    'Pennsylvania',
                    'Rhode Island',
                    'South Carolina',
                    'South Dakota',
                    'Tennessee',
                    'Texas',
                    'Utah',
                    'Vermont',
                    'Virginia',
                    'Washington',
                    'West Virginia',
                    'Wisconsin',
                    'Wyoming']
    let colorScale = d3.scaleOrdinal().domain(['California', ...states]).range(['steelblue', ...d3.schemeSet3, ...d3.schemePaired, ...d3.schemeSet1, ...d3.schemeSet2]);
    /**************************/
    /********* Chart 1 ********/
    /**************************/
    function plotChart1Legend(container, size, data, handle, xSlider) {
        // The code below is adapted from: https://observablehq.com/d/0c6c3b21d7c39e6c

        const titlePadding = 25;  // padding between title and entries
        const entrySpacing = 16;  // spacing between legend entries
        const entryRadius = 10;    // radius of legend entry marks
        const labelOffset = 4;    // additional horizontal offset of text labels
        const baselineOffset = 4; // text baseline offset, depends on radius and font size

        const legendValues = [
            // Min: 64,757
            // Max: 6,312,623
            { index: 0, label: 50000},
            { index: 1, label: 250000},
            { index: 2, label: 1000000},
            { index: 3, label: 2500000},
            { index: 4, label: 5000000}
        ]

        const title = container.append('text')
            .attr('x', 0)
            .attr('y', 0)
            .attr('fill', 'black')
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .attr('font-weight', 'bold')
            .attr('font-size', '12px')
            .text('# Students');

        const entries = container.selectAll('g')
            .data(legendValues)
            .join('g')
            .attr('transform', d => `translate(${entrySpacing}, ${titlePadding + d.index * size(d.label)})`);

        const symbols = entries.append('circle')
            .attr('class', 'chart1-legend-circles')
            .attr('cx', d => -entryRadius) // <-- offset symbol x-position by radius
            .attr('cy', d => entryRadius * d.index) // <-- offset symbol x-position by radius
            .attr('r', d => size(d.label))
            .attr('fill', 'silver');

        let handlePosition = handle.attr("cx");
        let year = xSlider.invert(handlePosition).getTime(); // current year
        symbols
            .on('mouseover', function(event, d) {
                d3.select(this).attr('stroke', '#333').attr('stroke-width', 2);
                let chart1Container = d3.select('#chart1')
                let chart1Marks = chart1Container.selectAll('.chart1-marks')
                chart1Marks
                    .attr('opacity', 0.2)
                    .filter(mark => mark.students >= d.label)
                    .attr('opacity', 0.70)
                    .attr('stroke', '#333').attr('stroke-width', 2)
            })
            .on('mouseout', function(event, d) {
                d3.select(this).attr('stroke', '#333').attr('stroke-width', 0);
                let chart1Container = d3.select('#chart1')
                let chart1Marks = chart1Container.selectAll('.chart1-marks')
                chart1Marks
                    .attr('opacity', 0.70)
                    .attr('stroke', '#333').attr('stroke-width', 0)
            })

        const labels = entries.append('text')
            .attr('x', entryRadius * 1.5) // <-- place labels to the left of symbols
            .attr('y', d => entryRadius * d.index) // <-- adjust label y-position for proper alignment
            .attr('fill', 'black')
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .attr('font-size', '11px')
            .style('user-select', 'none') // <-- disallow selectable text
            .text(d => d.label.toLocaleString()); // putting commas between thousands
    }

    function createChart1Scales(data) {
        // Creates the scales

        let xScalePopulation = d3.scaleLog()
                            .domain(d3.extent(data, d => d.pop))
                            .range([margins.left, width - margins.right])
                            .nice();

        let yScaleRawExpenditure = d3.scaleLinear()
                                     .domain(d3.extent(data, d => d.inflation_adj_exp_per_student))
                                     .range([height - margins.bottom, margins.top])
                                     .nice();

        let size = d3.scaleSqrt()
                     .domain(d3.extent(data, d => d.students))
                     .range([4, 25]) // output radii range from 4 to 35 pixels

        return {
            xScalePopulation,
            yScaleRawExpenditure,
            size
        }

    }

    function plotChart1Axes(data, xScale, yScale, container) {
        /*
            Plots the x and y axes for Chart 1
        */

        /* X-AXIS */
        let xAxis = d3.axisBottom(xScale).tickFormat((d, i) => {
            return d.toLocaleString(); // formats to put commas between digits
        });
        let xPos = width - margins.right;
        let yPos = -10;
        let xAxisTransform = `translate(0, ${height - margins.bottom})`;
        let xAxisTitle = 'State Population';
        let xAxisClass = 'chart1-xaxis';
        container.append('g')
                    .attr('class', xAxisClass)
                    .attr('transform', xAxisTransform)
                    .call(xAxis)
                        .selectAll('text')
                        .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr('transform', 'rotate(-65)')
        // Appends the x-axis title below
        // I have to plot it separately because otherwise it also gets rotated with the ticks
        const xAxisLabel = container.append('text')
                            .attr('transform', xAxisTransform)
                            .attr('class', 'chart1-xaxis-label')
                            .attr('text-anchor', 'end')
                            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                            .attr('fill', 'black')
                            .attr('font-size', 18)
                            .attr('font-weight', 'bold')
                            .attr('x', xPos)
                            .attr('y', yPos)
                            .text(xAxisTitle)
        /* Y-AXIS */
        let expenditureFormat = "$,.2r"; // currency, grouped by every three order of magnitudes with commas in between, with two significant digits
        let tickFormat = yScale.tickFormat(15, expenditureFormat); // Formats the y-ticks to be more readable

        let yAxis = d3.axisLeft(yScale).tickFormat(tickFormat);
        let yAxisTransform = `translate(${margins.left}, 0)`;
        let yAxisTitle = 'Per Student Spending';
        let yAxisClass = 'chart1-yaxis';
        let yAxisTitleTransform = `translate(20, ${margins.top}) rotate(-90)`

        container.append('g')
                    .attr('class', yAxisClass)
                    .attr('transform', yAxisTransform)
                    .call(yAxis)
                    // Formats axis title
                    .append('text')
                        .attr('transform', yAxisTitleTransform)
                        .attr('text-anchor', 'end')
                        .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                        .attr('fill', 'black')
                        .attr('font-size', 18)
                        .attr('font-weight', 'bold')
                        .text(yAxisTitle);
    }

    function plotChart1YearLabel(year, container) {
        container.selectAll('.chart1-yearLabel').remove();

        const yearLabel = container.append('text')
            .attr('class', 'chart1-yearLabel')
            .attr('x', margins.left)
            .attr('y', height - margins.bottom - 20)
            .attr('fill', orange) // dark orange
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .attr('font-weight', 500)
            .attr('font-size', 80)
            .text(year);
    }

    function plotChart1MedianLine(data, yScale, container, t) {
        // Plotting the median line
        const medianLine = container.selectAll(".chart1-median-line")
                            .data([ data ]);

        medianLine.raise()

        medianLine.transition(t)
                  .attr('y1', data => {
                    let medianStateSpending = d3.median(data, d => d.inflation_adj_exp_per_student);
                    return yScale(medianStateSpending)
                  })
                  .attr('y2', data => {
                    let medianStateSpending = d3.median(data, d => d.inflation_adj_exp_per_student);
                    return yScale(medianStateSpending)
                  })

        medianLine.enter().append('line')
                          .attr('class', 'chart1-median-line')
                          .attr("x1", margins.left)
                          .attr("x2", width - margins.right)
                          .attr('y1', data => {
                              let medianStateSpending = d3.median(data, d => d.inflation_adj_exp_per_student);
                              return yScale(medianStateSpending)
                          })
                          .attr('y2', data => {
                              let medianStateSpending = d3.median(data, d => d.inflation_adj_exp_per_student);
                              return yScale(medianStateSpending)
                          })
                          .attr("stroke", "forestgreen")
                          .attr('opacity', 0.8)
                          .attr('stroke-width', 2)
                          .attr('stroke-linecap', 'round')
                          .attr('stroke-dasharray', '5,5')
                          .style("pointer-events","none");

        // Plotting the text "Median Spending"
        let medianStateSpending = d3.median(data, d => d.inflation_adj_exp_per_student);
        const medianLineText = container.selectAll(".chart1-median-line-text")
                            .data([ data ]);
        medianLineText.raise();

        medianLineText.transition(t)
                      .attr('y', d =>  {
                        return yScale(medianStateSpending)
                       })
                      .text(d => {
                          return "Median Spending: $" + parseInt(medianStateSpending).toLocaleString()
                       })

        medianLineText.enter().append('text')
                          .attr('class', 'chart1-median-line-text')
                          .attr('x', width - margins.right)
                          .attr('y', d =>  {
                              return yScale(medianStateSpending)
                          })
                          .attr('dy', -10)
                          .style("pointer-events","none")
                          .attr('text-anchor', 'end')
                          .attr('fill', 'forestgreen')
                          .attr('font-size', 12)
                          .attr('font-weight', 'bold')
                          .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                          .text(d => {
                              return "Median Spending: $" + parseInt(medianStateSpending).toLocaleString()
                            })
                          ;
    }

    function plotChart1Marks(data, xScale, yScale, size, container) {
        let t = d3.transition()
                  .duration(750)
                  .ease(d3.easeCubic)

        const stateMarks = container.selectAll('.chart1-marks')
                                    .data(data, d => d.state) // giving a key for updating svg elements

        // From Mike Bostock's: https://bl.ocks.org/mbostock/3808234/457c620cab92e5dc9b8351b31a572fe6eb7d51d7
        // EXIT when a state leaves the dataset (i.e. no data)
        stateMarks.exit()
                  .transition(t)
                    .attr("cy", height - 100)
                    .style("fill-opacity", 1e-6) // fades out
                    .remove();

        let highlightedStates = ['California']
        let comparisonState = d3.select("#chart1-comparison-state").node().value;

        if (comparisonState) { // selected
            highlightedStates.push(comparisonState);
        }

        let marksOpacityFaded = 0.70;
        let marksOpacityFull = 0.90;

        // UPDATE old elements present in the new data (new results)
        stateMarks.transition(t)
                    .attr('id', d => 'circle-' + d.state + '-' + d.year)
                    .attr('cx', d => xScale(d.pop))
                    .attr('cy', d => yScale(d.inflation_adj_exp_per_student))
                    .attr('r', d => size(d.pop))
                    .attr('fill', '#ccc')
                    .attr('opacity', marksOpacityFaded)
                    .filter(d => highlightedStates.includes(d.state))
                        .attr('fill', d => colorScale(d.state))
                        .attr('opacity', marksOpacityFull)
                        .each(function(d) {
                            d3.select(this).raise(); // raising the selected element on top of the other marks.
                        })

        // Adding a tooltip
        // ENTER new elements present in the data
        stateMarks.enter().append('circle')
                    .sort((a, b) => b.pop - a.pop) // smaller states drawn last
                    .attr('id', d => 'circle-' + d.state + '-' + d.year)
                    .attr('class', 'chart1-marks')
                    .transition(t)
                        .attr('stroke-width', 0.5)
                        .attr('stroke', 'darkgray')
                        .attr('opacity', d => d.state === 'California' ? marksOpacityFull : marksOpacityFaded) // start California off with a higher opacity
                        .attr('fill', d => {
                            if (highlightedStates.includes(d.state)) {
                                return colorScale(d.state)
                            } else {
                                return '#ccc'
                            }
                        }) // just highlighting California whent the bubbles first come in
                        .attr('cx', d => xScale(d.pop))
                        .attr('cy', d => yScale(d.inflation_adj_exp_per_student))
                        .attr('r', d => size(d.pop))

        let currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        })

        // Create little bits of text that is displayed on the circles
        let texts = container.selectAll(".chart1-text")
                             .data(data, d => d.state);

        texts.exit()
             .transition(t)
                .attr("cy", height - 100)
                .style('fill-opacity', 1e-6)
                .remove();

        texts.enter().append('text') // TODO: Change this to a rect and make a tooltip rather than plain text
            .attr('class', 'chart1-text')
            .attr('id', d => 'chart1-text-' + d.state.replaceAll(" ", "")) // Removing spaces in state name so selection by element id can work later
            .lower()
            .attr('opacity', 0) // rendering the text invisible at first, until we hover over it.
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .text(d => d.state)
            .attr('x', d => xScale(d.pop)) // TODO: Move the text out of the circle (and probably have a better Tooltip) and also stylize text better
            .attr('y', d => yScale(d.inflation_adj_exp_per_student))
            .attr('dx', d => size(d.pop) * 1.2) // Moving the text label away from the circle itself. TODO: Nice-to-have, have the text follow the cursor around
            .attr('dy', -10)
            .attr('pointer-events', 'none')

        texts.transition(t)
            .attr('x', d => xScale(d.pop))
            .attr('y', d => yScale(d.inflation_adj_exp_per_student))

        const marks = container.selectAll('.chart1-marks') // can't use stateMarks here for some reason. Otherwise '.append' is not a function on the promise.

        // Adding mouseover effects with tooltip
        // Border and raising the element
        // Should also bring up a tooltip that shows a bit of text.
        marks.on('mouseover', function() {
                // TODO: Add a tooltype with text that shares more info about the state (population, spending, teachers, year etc.)
                // See: https://observablehq.com/@luizaugustomm/tooltip
                // And: https://observablehq.com/@clhenrick/tooltip-component

                // Stylizes with a border around the circle
                d3.select(this).attr('stroke', '#333').attr('stroke-width', 2).attr('opacity', marksOpacityFull);
                d3.select(this).raise();

                // Raises the text over the circle
                let stateName = d3.select(this).attr('id').split('-')[1].replaceAll(" ", "") // returns state name from "circle-California-1970"
                let stateId = '#chart1-text-' + stateName;
                let stateText = d3.select(stateId)
                stateText.attr('opacity', 1).raise(); // Placing the text on top of the circle
            })

            .on('mouseout', function() {
                // Lowering the circle and removing the highlight back to the default
                let elem = d3.select(this);
                elem.attr('stroke', 'darkgray').attr('stroke-width', 0.5).attr('opacity', marksOpacityFaded);

                // Lowering the text so it doesn't block the other circles
                let stateName = d3.select(this).attr('id').split('-')[1].replaceAll(" ", "") // returns state name from "circle-California-1970"
                let stateText = d3.select('#chart1-text-' + stateName)
                stateText.attr('opacity', 0)


                d3.selectAll(".chart1-text").lower() // lowering all the text
            })

        plotChart1MedianLine(data, yScale, container, t)
    }


    function pressChart1Button(buttonRunning, handle, data, xScale, yScale, size, container, xSlider) {
        let interval;
        let maxYear = d3.max(data, d => d.year); // this is where the slider should stop.

        // First, figure out where the slider currently is
        let handlePosition = handle.attr("cx");
        let year = xSlider.invert(handlePosition).getTime(); // current year
        let nextYear = year + 1;
        let button = d3.select("#chart1-button");

        // Then, call updateChart1Slider() with some delay via setInterval
        interval = setInterval(function() {
            if (nextYear <= maxYear) {
                updateChart1Slider(nextYear, handle, data, xScale, yScale, size, container, xSlider);
                nextYear += 1; // go to the next year when called
            } else {
                clearInterval(interval); // we're at the end of the slider and we should stop
                button.node().textContent = "Restart"
            }
        }, 750)

        return interval;
    }

    function updateChart1Slider(year, handle, data, xScale, yScale, size, container, xSlider) {
            // update position and text of label according to slider scale
            let t = d3.transition().duration(200).ease(d3.easeCubic);
            handle.transition(t)
                  .attr("cx", xSlider(year))
            ;
            // filter data set and redraw plot
            var newData = data.filter(function(d) {
                return d.year == year;
            })

            plotChart1Marks(newData, xScale, yScale, size, container);
            plotChart1YearLabel(year, container);
    }

    function plotChart1DateSlider(data, xScale, yScale, size, container) {
        /*
            Creates a time slider for the data.
            Adapted from Jane Hong's template: https://bl.ocks.org/officeofjane/9b9e606e9876e34385cc4aeab188ed73
        */

        let startDate = d3.min(data, d => d.year),
            endDate = d3.max(data, d => d.year);

        let sliderWidth = width - margins.right;
        let sliderHeight = 100;

        let svgSlider = d3.select('#chart1-slider')
            .append('svg')
            .attr('width', sliderWidth)
            .attr('height', sliderHeight);

        let xSlider = d3.scaleTime() // scaleTime creates discrete "stops" when I am dragging the handle. scaleLinear allows for continous sliding
            .domain([startDate, endDate])
            .range([0, sliderWidth - margins.right])
            .clamp(true);

        let slider = svgSlider.append('g')
                              .attr('class', 'chart1-slider-elements')
                              .attr('transform', `translate(${margins.left - 10}, ${sliderHeight / 3})`);

        slider.append('line')
                .attr('class', 'chart1-slidertrack')
                .attr('x1', xSlider.range()[0]) // beginning of slider
                .attr('x2', xSlider.range()[1]) // end of slider
              .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr('class', 'track-inset')
              .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function() { slider.interrupt(); })
                    .on("start drag", function(event) {
                        // Given the x-coordinate of the slider, I need to figure out to figure out what year the slider is on
                        let year = xSlider.invert(event.x).getTime();
                        updateChart1Slider(year, handle, data, xScale, yScale, size, container, xSlider);
                    }));

        // Adding tick labels
        let numTicks = endDate - startDate;
        let tickLabels = [...Array(numTicks).keys()].map(d => d + startDate) // Makes the ticks 1970 to the end
        tickLabels.push(2016) // Adding the last tick
        slider.insert("g", ".track-overlay")
                .attr("class", "slider-ticks")
                .attr("transform", "translate(0, 18)")
              .selectAll("text")
                .data(tickLabels)
                .enter()
                    .append("text")
                    .attr('font-size', 14)
                    .classed('rotation', true)
                    .attr("text-anchor", "middle")
                    .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                    .text(function(d) {
                        return d;
                    })
                    .attr('transform', (d, i) => { // rotates all the text labels of years to be more readable
                        return `translate(${xSlider(d)}, 20), rotate(90)`
                    })
                    ;

        let handle = slider.insert("circle", ".track-overlay")
                           .attr("class", "handle")
                           .attr("r", 9);

        return { handle, xSlider }

    }

    function setupChart1Button(handle, data, xScale, yScale, size, container, xSlider) {
        let year;
        let button = d3.select("#chart1-button");
        let minYear = d3.min(data, d => d.year);
        let maxYear = d3.max(data, d => d.year);
        button.running = false;
        let interval;
        button.on("click", function() {
            let handlePosition = handle.attr("cx");
            year = xSlider.invert(handlePosition).getTime(); // current year
            if (year === maxYear) {
                // Restart
                interval = pressChart1Button(button.running, handle, data, xScale, yScale, size, container, xSlider); // toggles button running
                button.node().textContent = "Pause";
            } else {
                if (!button.running) {
                    interval = pressChart1Button(button.running, handle, data, xScale, yScale, size, container, xSlider); // toggles button running
                    button.node().textContent = "Pause";
                } else {
                    clearInterval(interval);
                    button.node().textContent = "Play";
                }
                button.running = !button.running;
            }

        });
    }

    function plotChart1(data) {
        /*
            Plots all of Chart 1
        */
        const plotContainer = d3.select("#chart1").append('svg')
            .attr('id', 'chart1-svg')
            .attr('width', width)
            .attr('height', height);

        let { xScalePopulation, yScaleRawExpenditure, size } = createChart1Scales(data);
        let minYear = d3.min(data, d => d.year);
        plotChart1Axes(data, xScalePopulation, yScaleRawExpenditure, plotContainer);
        plotChart1YearLabel(minYear, plotContainer);
        // Just plot the first year's worth of data
        plotChart1Marks(data.filter(d => d.year === minYear), xScalePopulation, yScaleRawExpenditure, size, plotContainer);
        let { handle, xSlider } = plotChart1DateSlider(data, xScalePopulation, yScaleRawExpenditure, size, plotContainer);
        setupChart1Button(handle, data, xScalePopulation, yScaleRawExpenditure, size, plotContainer, xSlider);

        // Plotting the legend
        let {top, left, right, bottom } = margins;

        let legend = plotContainer.append('g')
                     .attr('class', 'chart1-legend')
                     .attr('transform', `translate(${left + 100}, ${top + 10})`);
        plotChart1Legend(legend, size, data, handle, xSlider);

        // Allowing the user to select a comparison state
        function updateChart1OnSelection(event) {
            let handlePosition = handle.attr("cx");
            let year = xSlider.invert(handlePosition).getTime(); // current year
            plotChart1Marks(data.filter(d => d.year === year), xScalePopulation, yScaleRawExpenditure, size, plotContainer)
        }
        d3.select("#chart1-comparison-state").on("change", updateChart1OnSelection);

    }

    /**************************/
    /********* Chart 2 ********/
    /**************************/
    let chart2Width = 1250;
    let chart2Height = 250;
    let chart2Margins = {
        top: 10,
        right: 100,
        bottom: 50,
        left: 100
    }

    function plotChart2(data) {
        /*
            Inspiration: https://observablehq.com/@d3/bar-chart-race
        */
        const plotContainer = d3.select("#chart2").append('svg')
            .attr('id', 'chart2-svg')
            .attr('width', chart2Width)
            .attr('height', chart2Height);

        let { heightScale, rankScale } = createChart2Scales(data, chart2Width, chart2Height, chart2Margins);
        let minYear = d3.min(data, d => d.year);
        createChart2Axes(data, rankScale, heightScale, chart2Width, chart2Height, chart2Margins, plotContainer)
        plotChart2YearLabel(minYear, chart2Width, chart2Height, chart2Margins, plotContainer)
        plotChart2Marks(data.filter(d => d.year === minYear), rankScale, heightScale, chart2Width, chart2Height, chart2Margins, plotContainer);
        let { handle, xSlider } = plotChart2DateSlider(data, rankScale, heightScale, chart2Width, chart2Height, chart2Margins, plotContainer);
        setupChart2Button(handle, data, rankScale, heightScale, xSlider)
    }

    function createChart2Scales(data, width, height, margins) {
        /*
            Creates the scale for the length of each bar.
        */
        let { top, bottom, left, right } = margins;
        let maxEffort = d3.max(data, d => d.effort)

        let heightScale = d3.scaleLinear()
                        .domain([0, maxEffort])
                        .range([height - bottom, top])
                        .clamp(true)
                        .nice();

        let rankScale = d3.scaleLinear()
                          .domain([1, 51])
                          .range([left, width - right])
                          .clamp(true)
                          .nice();

        return { heightScale, rankScale }
    }

    function createChart2Axes(data, rankScale, heightScale, width, height, margins, container) {
        /*
            Top Axis: Effort (proportion of per-capital income that a single student makes up in the state)
            Left Axis: Rank of 1 through 51
        */
       let { top, bottom, left, right } = margins;
       /* BOTTOM AXIS */
       let tickValues = [1,2,3,4,5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 51];
       let xAxis = d3.axisBottom(rankScale).tickValues(tickValues).tickPadding(5);

       container.append('g')
                    .attr('class', 'chart2-xaxis')
                    .attr('transform', `translate(0, ${height - bottom})`)
                    .call(xAxis)
                        .selectAll('text')
                        .attr('font-size', 16)
                        .style("text-anchor", "center")
                        .attr("dy", "1em")
        // Appends the x-axis title below

        // I have to plot it separately because otherwise it also gets rotated with the ticks
        let xPos = width/2;
        let yPos = 45;
        let xAxisTransform = `translate(0, ${height - bottom})`;
        let xAxisTitle = 'Ranking';
        const xAxisLabel = container.append('text')
                            .attr('transform', xAxisTransform)
                            .attr('class', 'chart1-xaxis-label')
                            .attr('text-anchor', 'end')
                            .attr('fill', 'black')
                            .attr('font-size', 18)
                            .attr('font-weight', 'bold')
                            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                            .attr('x', xPos)
                            .attr('y', yPos)
                            .text(xAxisTitle)

        /* LEFT AXIS */
        let yAxis = d3.axisLeft(heightScale).tickFormat(d => String(d) + '%')
        let yAxisTitlePt1 = 'Per-Student Spending';
        let yAxisTitlePt2 = '(% of Avg. Income)';
        let yAxisClass = 'chart2-yaxis';
        let yAxisTitleTransform1 = `translate(${-left/1.5}, ${top + 20}) rotate(-90)`
        let yAxisTitleTransform2 = `translate(${-left/2}, ${top + 30}) rotate(-90)`
        const yAxisElem = container.append('g')
                                .attr('class', yAxisClass)
                                .attr('transform', `translate(${left}, 0)`)
                                .call(yAxis)
        yAxisElem.append('text')
                        .attr('id', 'chart2-yaxis-title1')
                        .attr('transform', yAxisTitleTransform1)
                        .attr('font-size', 14)
                        .style('text-anchor', 'center')
                        .attr('font-weight', 'bold')
                        .attr('fill', 'black')
                        .text(yAxisTitlePt1)
                        ;

        yAxisElem.append('text')
                        .attr('transform', yAxisTitleTransform2)
                        .attr('font-size', 14)
                        .style('text-anchor', 'center')
                        .attr('font-weight', 'bold')
                        .attr('fill', 'black')
                        .text(yAxisTitlePt2)
                        ;
    }

    function plotChart2YearLabel(year, width, height, margins, container) {
        let { top, bottom, left, right } = margins;
        container.selectAll('.chart2-yearLabel').remove();

        const yearLabel = container.append('text')
            .attr('class', 'chart2-yearLabel')
            .attr('x', width - right * 3)
            .attr('y', height / 2 - top * 2)
            .attr('fill', orange) // dark orange
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .attr('font-weight', 500)
            .attr('font-size', 80)
            .text(year);
    }

    function plotChart2Marks(data, rankScale, heightScale, width, height, margins, container) {

        let { top, bottom, left, right } = margins;
        let t = d3.transition()
                  .duration(750)
                  .ease(d3.easeCubic)

        let barWidth = width / 80;
        let xShift = 7; // the amount the bars should be shifted in order to be in the middle of each rank

        const stateMarks = container.selectAll('rect')
                                    .data(data, d => d.state) // giving a key for updating svg elements

        // From Mike Bostock's: https://bl.ocks.org/mbostock/3808234/457c620cab92e5dc9b8351b31a572fe6eb7d51d7
        // EXIT when a state leaves the dataset (i.e. no data)
        stateMarks.exit()
                  .transition(t)
                    .attr('height', 0)
                    .style("fill-opacity", 1e-6) // fades out
                    .remove();

        // UPDATE old elements present in the new data (new results)
        stateMarks.transition(t)
                    .attr('id', d => 'rect-' + d.state + '-' + d.year)
                    .attr('x', d => rankScale(d.effort_rank) - xShift)
                    .attr('y', d => heightScale(d.effort))
                    .attr('width', barWidth)
                    .attr('height', d => height - bottom - heightScale(d.effort))
                    .attr('opacity', 0.70)

        // Adding a tooltip
        // TODO: Remove the below and implement a nicer tooltip
        // ENTER new elements present in the data
        let strokeColor = 'white';
        let strokeWidth = 1;
        stateMarks.enter().append('rect')
                    .attr('id', d => 'rect-' + d.state + '-' + d.year)
                    .attr('class', 'chart2-marks')
                    .transition(t)
                        .attr('stroke-width', strokeWidth)
                        .attr('stroke', strokeColor)
                        .attr('opacity', 0.70)
                        .attr('fill', d => d.state === 'California' ? 'steelblue' : '#ccc') // just highlighting California whent the bubbles first come in
                        .attr('x', d => rankScale(d.effort_rank) - xShift)
                        .attr('y', d => heightScale(d.effort))
                        .attr('width', barWidth)
                        .attr('height', d => height - bottom - heightScale(d.effort)) // height goes downwards


        // Create little bits of text that is displayed on the circles
        let texts = container.selectAll(".chart2-text")
                             .data(data, d => d.state);

        texts.exit()
             .transition(t)
                .attr("cy", height - 100)
                .style('fill-opacity', 1e-6)
                .remove();

        texts.enter().append('text')
            .attr('class', 'chart2-text')
            .attr('id', d => 'chart2-text-' + d.state.replaceAll(" ", "")) // Removing spaces in state name so selection by element id can work later
            .lower()
            .attr('opacity', 0) // rendering the text invisible at first, until we hover over it.
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .text(d => d.state)
            .attr('x', d => rankScale(d.effort_rank) - xShift)
            .attr('y', d => heightScale(d.effort))
            .attr('dx', 0)
            .attr('dy', -20)

        texts.transition(t)
            .attr('x', d => rankScale(d.effort_rank) - xShift)
            .attr('y', d => heightScale(d.effort))
            .attr('dy', -20)

        const marks = container.selectAll('rect') // can't use stateMarks here for some reason. Otherwise '.append' is not a function on the promise.

        // Adding mouseover effects with tooltip
        // Border and raising the element
        // Should also bring up a tooltip that shows a bit of text.
        marks
            .on('mouseover', function() {
                // TODO: Add a tooltype with text that shares more info about the state (population, spending, teachers, year etc.)
                // See: https://observablehq.com/@luizaugustomm/tooltip
                // And: https://observablehq.com/@clhenrick/tooltip-component

                // Stylizes with a border around the bar
                d3.select(this).attr('stroke', 'steelblue').attr('stroke-width', 1);

                // Raises the text over the circle
                let stateName = d3.select(this).attr('id').split('-')[1].replaceAll(" ", "") // returns state name from "circle-California-1970"
                let stateId = '#chart2-text-' + stateName;
                let stateText = d3.select(stateId)
                stateText.attr('opacity', 1).raise(); // Placing the text on top of the circle
            })
            .on('mouseout', function() {
                // Lowering the circle and removing the highlight back to the default
                let elem = d3.select(this);
                elem.attr('stroke', strokeColor).attr('stroke-width', strokeWidth);

                // Lowering the text so it doesn't block the other circles
                let stateName = d3.select(this).attr('id').split('-')[1].replaceAll(" ", "") // returns state name from "circle-California-1970"
                let stateText = d3.select('#chart2-text-' + stateName)
                stateText.attr('opacity', 0)

                d3.selectAll(".chart2-text").lower() // lowering all the text
            })
            .on("click", function(event) {
                // Allows selection of a state to highlight
                let elem = d3.select(this);
                elem.classed("selected", elem.classed("selected") ? false : true);
            })
    }

    function plotChart2DateSlider(data, rankScale, heightScale, width, height, margins, container) {
        /*
            Creates a time slider for the data.
            Adapted from Jane Hong's template: https://bl.ocks.org/officeofjane/9b9e606e9876e34385cc4aeab188ed73
        */
        let { top, bottom, left, right } = margins;

        let startDate = d3.min(data, d => d.year),
            endDate = d3.max(data, d => d.year);

        let sliderWidth = width - right;
        let sliderHeight = 100;

        let svgSlider = d3.select('#chart2-slider')
            .append('svg')
            .attr('width', sliderWidth)
            .attr('height', sliderHeight);

        let xSlider = d3.scaleTime() // scaleTime creates discrete "stops" when I am dragging the handle. scaleLinear allows for continous sliding
            .domain([startDate, endDate])
            .range([0, sliderWidth - right])
            .clamp(true);

        let slider = svgSlider.append('g')
                              .attr('class', 'chart2-slider-elements')
                              .attr('transform', `translate(${left - 10}, ${sliderHeight/10})`);

        slider.append('line')
                .attr('class', 'chart2-slidertrack')
                .attr('x1', xSlider.range()[0]) // beginning of slider
                .attr('x2', xSlider.range()[1]) // end of slider
              .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr('class', 'track-inset')
              .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                .attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function() { slider.interrupt(); })
                    .on("start drag", function(event) {
                        // Given the x-coordinate of the slider, I need to figure out to figure out what year the slider is on
                        let year = xSlider.invert(event.x).getTime();
                        updateChart2and3(year, handle, data, rankScale, heightScale, xSlider);
                    }));

        let numTicks = endDate - startDate;
        let tickLabels = [...Array(numTicks).keys()].map(d => d + startDate) // Makes the ticks 1970 to the end
        tickLabels.push(2016) // Adding the last tick
        slider.insert("g", ".track-overlay")
                .attr("class", "slider-ticks")
                .attr("transform", "translate(0, 18)")
              .selectAll("text")
                .data(tickLabels)
                .enter()
                    .append("text")
                    .attr('font-size', 14)
                    .classed('rotation', true)
                    .attr("text-anchor", "middle")
                    .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
                    .text(function(d) {
                        return d;
                    })
                    .attr('transform', (d, i) => { // rotates all the text labels of years to be more readable
                        return `translate(${xSlider(d)}, 20), rotate(90)`
                    })
                    ;

        let handle = slider.insert("circle", ".track-overlay")
                           .attr("class", "handle")
                           .attr("r", 9);

        return { handle, xSlider }
    }

    function updateChart2and3(year, handle, data, rankScale, heightScale, xSlider) {

            let chart2Container = d3.select('#chart2-svg');
            let chart3Container = d3.select('#chart3-svg');
            // update position and text of label according to slider scale

            handle.attr("cx", xSlider(year));

            // filter data set and redraw plot
            var newData = data.filter(function(d) {
                return d.year == year;
            })

            plotChart2Marks(newData, rankScale, heightScale, chart2Width, chart2Height, chart2Margins, chart2Container);
            plotChart2YearLabel(year, chart2Width, chart2Height, chart2Margins, chart2Container);
            // We also need to update Chart 3's marker
            let allSel = chart3Container.selectAll('.chart3-rankingcircle').attr('opacity', 1e-6)
            let sel = chart3Container.select('#chart3-circle-' + year)
            sel.attr('opacity', 0.9)

            // And updating the label as well
            plotChart3RankLabel(data, year, chart3Container)
    }

    function setupChart2Button(handle, data, xScale, yScale, xSlider) {

        let year;
        let button = d3.select("#chart2-button");
        let minYear = d3.min(data, d => d.year);
        let maxYear = d3.max(data, d => d.year);
        button.running = false;
        let interval;
        button.on("click", function() {
            let handlePosition = handle.attr("cx");
            year = xSlider.invert(handlePosition).getTime(); // current year
            if (year === maxYear) { // If we are at the last year
                // Restart
                interval = pressChart2Button(button.running, minYear, handle, data, xScale, yScale, xSlider); // toggles button running
                button.node().textContent = "Pause"
            } else {
                if (!button.running) {
                    interval = pressChart2Button(button.running, year, handle, data, xScale, yScale, xSlider); // toggles button running
                    button.node().textContent = "Pause";
                } else {
                    clearInterval(interval);
                    button.node().textContent = "Start";
                }
                button.running = !button.running;
            }
        });
    }

    function pressChart2Button(buttonRunning, year, handle, data, xScale, yScale, xSlider) {
        let button = d3.select("#chart2-button");
        let interval;
        let maxYear = d3.max(data, d => d.year); // this is where the slider should stop.

        // First, figure out where the slider currently is
        let handlePosition = handle.attr("cx");
        let nextYear = year + 1;

        // Then, call updateChart2and3() with some delay via setInterval
        interval = setInterval(function() {
            if (nextYear <= maxYear) {
                updateChart2and3(nextYear, handle, data, xScale, yScale, xSlider);
                nextYear += 1; // go to the next year when called
            } else {
                clearInterval(interval); // we're at the end of the slider and we should stop
                button.node().textContent = 'Restart'
            }
        }, 1000)

        return interval;
    }
    /**************************/
    /********* Chart 3 ********/
    /**************************/
    let chart3Width = 1250;
    let chart3Height = 350;
    let chart3Margins = {
        top: 10,
        right: 100,
        bottom: 50,
        left: 100
    }

    // Data from: https://edpolicyinca.org/publications/securing-and-protecting-education-funding-california
    const chart3Tooltips = [
        {
            year: 1978,
            event: "Proposition 13",
            description: "Dramatically limited annual property tax increases by capping tax rates and assessed value. It also limited state and local ability to raise taxes."
        },
        {
            year: 1988,
            event: "Proposition 98",
            description: "Created a constitutional minimum guaranteed funding level for K-12 and community college education."
        },
        {
            year: 1972,
            event: "Senate Bill 90",
            description: "Increased state aid and established a revenue limit system in an attempt to equalize the amount of funding received by districts."
        },
        {
            year: 1971,
            event: "Serrano v. Priest",
            description: "Established that California must reduce local wealth-based funding disparities."
        },
        {
            year: 1979,
            event: "Assembly Bill 8",
            description: "Determined how much local property tax revenue goes to school districts."
        },
        {
            year: 1992,
            event: "Augmentation",
            description: "Shifted some local property tax renuve into separate fund to help meet Prop 98's minimum funding requirement."
        },
        {
            year: 2008,
            event: "US Recession",
            description: "The great recession begins in late-2008."
        },
        {
            year: 1991,
            event: "Realignment",
            description: "Redirected certain programs and tax revenues from the state General Fund to local governments and/or Special Funds, effectively lowering the Propsition 98 guarantee."
        },
        {
            year: 2011,
            event: "Realignment",
            description: "Just like in 1991, another realignment was done, again lowering Prop 98's funding guarantee."
        },
        {
            year: 2016,
            event: "Proposition 55",
            description: "Extended the personal income tax increases established by Proposition 30."
        },
        {
            year: 2012,
            event: "Proposition 30",
            description: "Increased sales tax rate and the income tax rate for high-income earners, in order to prevent cuts to education."
        },
    ]

    function plotChart3Tooltips(xScale, yScale, container) {
        /*
        Creates a bunch of tooltips.
        */
        let { top, right, bottom, left } = chart3Margins;
        let tooltipHeight = 50;
        let tooltipWidth = 100;

        let textLeftPadding = tooltipWidth / 30;
        let textTopPadding = tooltipHeight / 1.75;

        const tooltips = container.append('g')
                                  .selectAll('.chart3-tooltips')
                                  .data(chart3Tooltips)
                                  .join('rect')
                                  .attr('class', 'chart3-tooltips')
                                  .attr('id', d => 'chart3-tooltip-' + d.year)
                                  .attr('width', tooltipWidth)
                                  .attr('height', tooltipHeight)
                                  .attr('rx', 15)
                                  .attr('x', d => xScale(new Date(d.year, 1, 1)) - tooltipWidth / 2) // centering the tooltip over the year
                                  .attr('y', chart3Height - bottom - tooltipHeight)
                                  .attr("opacity", 0) // making them invisible at first.
                                  .attr("fill", "beige")
                                  .attr("pointer-events", "none")
                                  ;
        // The text inside of each tooltip.
        const textTooltips = container.append('g')
                                      .selectAll('.chart3-tooltips-text')
                                      .data(chart3Tooltips)
                                      .join('text')
                                      .attr('id', d => 'chart3-tooltips-text-' + d.year)
                                      .attr('opacity', 0)
                                      .attr('class', 'chart3-tooltips-text')
                                      .attr('x', d => xScale(new Date(d.year, 1, 1)) - tooltipWidth / 2 + textLeftPadding) // centering the tooltip over the year
                                      .attr('y', chart3Height - bottom - tooltipHeight + textTopPadding)
                                      .attr('textLength', tooltipWidth - 2 * textLeftPadding) // adjusting to make sure the text fits perfectly in the tooltip
                                      .attr('font-family', "Helvetica Neue, Arial, sans-serif")
                                      .text(d => d.event)
                                      .attr("pointer-events", "none")
                             ;

        return { tooltips, textTooltips }
    }

    function createTextExplainer(d) {
        let year = d.year;
        let event = d.event;
        let description = d.description;

        return `<b>${year}:</b> ${event}
        </br>
        ${description}
        `
    }

    function showChart3Tooltips(x, tooltips, textTooltips) {
        let range = 15;
        textTooltips.attr('opacity', 0);
        tooltips.attr('opacity', 0)
                .filter(function(d) {
                    let year = d.year;
                    let elem = d3.select(this);
                    let rectX = +elem.attr('x'); // the X position of the tooltip
                    let tooltipWidth = +elem.attr('width');

                    let tooltipCenter = rectX + tooltipWidth / 2;

                    /*
                    . = center of the tooltip rect x position
                    | = the boundaries

                    |------.------|

                    If the mouse is within the boundaries of any tooltip, show them.
                    */
                    if (x <= tooltipCenter + range &&  // to the left of the boundary
                        x >= tooltipCenter - range) {  // to the right of the boundary
                            d3.select('#chart3-tooltips-text-' + year).attr('opacity', 1)
                            d3.select("#chart3-explainer").html(createTextExplainer(d))
                            return true;
                    }
                    return false
                })
                .attr('opacity', 0.9)
    }

    function plotChart3VLine(container, tooltips, textTooltips) {
        // The below plots a vertical line that moves with the mouse
        let { top, right, bottom, left } = chart3Margins;

        const line = container.append("line")
                                  .attr("y1", top - 10)
                                  .attr("y2", chart3Height - bottom)
                                  .attr("stroke", "rgba(0,0,0,0.2)")
                                  .style("pointer-events","none");

        container.on("mousemove", function(event, d) {
            let [x, y] = d3.pointer(event);
            if (x < left) x = left; // clamping at the left
            if (x > chart3Width - right) x = chart3Width - right; // clamping at the right
            line.attr("transform", `translate(${x}, 0)`); // Moving the line with the mouse

            showChart3Tooltips(x, tooltips, textTooltips);

        })

    }

    function plotChart3(data) {
        /*
            Inspiration: https://observablehq.com/@d3/bar-chart-race
        */
        const plotContainer = d3.select("#chart3").append('svg')
            .attr('id', 'chart3-svg')
            .attr('width', chart3Width)
            .attr('height', chart3Height);
        let { xScale, yScale } = getChart3Scales(data, chart3Width, chart3Height, chart3Margins)
        plotChart3Axes(data, xScale, yScale, chart3Width, chart3Height, chart3Margins, plotContainer);
        plotChart3Marks(data, 1970, xScale, yScale, chart3Width, chart3Height, chart3Margins, plotContainer);
        plotChart3RankLabel(data, 1970, plotContainer);
        let { tooltips, textTooltips } = plotChart3Tooltips(xScale, yScale, plotContainer);
        plotChart3VLine(plotContainer, tooltips, textTooltips);
    }

    function getChart3Scales(data, width, height, margins) {
        let { top, bottom, left, right } = margins;

        let minYear = d3.min(data, d => d.year);
        let maxYear = d3.max(data, d => d.year);
        let xScale = d3.scaleTime()
                        .domain([new Date(minYear, 0, 0), new Date(maxYear, 0, 0)])
                        .range([left, width - right])
                        .clamp(true);

        let yScale = d3.scaleLinear()
                          .domain([1, 51])
                          .range([top, height - bottom]) // rank 1 will be at the top of the screen
                          .clamp(true)
                          .nice();

        return { xScale, yScale }
    }

    function plotChart3Axes(data, xScale, yScale, width, height, margins, container) {
        let { top, bottom, left, right } = margins;

        /* BOTTOM AXIS*/
        let keepYears = [1970, 1971, 1972, 1978, 1979, 1988, 1991, 1992, 2008, 2011, 2012, 2016]
        let xTickValues = keepYears.map(d => new Date(d, 1, 1)) // converting the integers into a date

        let xAxis = d3.axisBottom(xScale).tickValues(xTickValues).tickFormat(d => "'" + d3.timeFormat('%y')(d)).tickPadding(5);
        container.append('g')
                    .attr('class', 'chart3-xaxis')
                    .attr('transform', `translate(0, ${height - bottom})`)
                    .call(xAxis)
                        .selectAll('text')
                        .attr('font-size', 16)
                        .style("text-anchor", "center")
                        .attr("dy", "1em")

        /* LEFT AXIS */
        let yTickValues = [1,5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
        let yAxis = d3.axisLeft(yScale).tickValues(yTickValues).tickPadding(5);
        let yAxisTitle = 'California State Ranking';
        let yAxisClass = 'chart3-yaxis';
        let yAxisTitleTransform = `translate(${-left/2}, ${top + 20}) rotate(-90)`
        container.append('g')
                    .attr('class', yAxisClass)
                    .attr('transform', `translate(${left}, 0)`)
                    .call(yAxis)
                    .append('text')
                        .attr('transform', yAxisTitleTransform)
                        .attr('font-size', 20)
                        .style('text-anchor', 'left')
                        .attr('font-weight', 'bold')
                        .attr('fill', 'black')
                        .text(yAxisTitle)
    }

    function plotChart3RankLabel(data, year, container) {
        let californiaData = data.filter(d => d.state === 'California' && d.year === year)
        let rank = californiaData[0].effort_rank;

        let { top, bottom, left, right } = chart3Margins;
        container.selectAll('.chart3-rankLabel').remove();
        /*
        <text class="chart2-yearLabel" x="950" y="105" fill="#bf7a1a" font-family="Helvetica Neue, Arial, sans-serif" font-weight="500" font-size="80">1976</text>

        <text class="chart3-rankLabel" x="500" y="155" fill="#bf7a1a" font-family="Helvetica Neue, Arial, sans-serif" font-weight="500" font-size="80">1976 Rank: 31</text>
        */

        function formatRanking(rank) {
            let lastNum = rank % 10;

            let mapping = {
                1: 'st',
                2: 'nd',
                3: 'rd',
            }

            if (lastNum in mapping) {
                return String(rank) + mapping[lastNum];
            } else {
                return String(rank) + 'th';
            }

        }

        const rankLabel = container.append('text')
            .attr('class', 'chart3-rankLabel')
            .attr('x', left * 1.2)
            .attr('y', top * 5)
            .attr('fill', orange) // dark orange
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .attr('font-weight', 700)
            .attr('font-size', 24)
            .text(`${year} Rank: `)
            .append("tspan")
            .attr('font-weight', 300)
            .attr('font-family', 'Helvetica Neue, Arial, sans-serif')
            .text(`${formatRanking(rank)} out of 51`)
            ;
    }

    function plotChart3Marks(data, year, xScale, yScale, width, height, margins, container) {
        let { top, bottom, left, right } = margins;
        let line = d3.line()
                     .x(function(d) {
                         return xScale(new Date(d.year, 0, 0))
                        })
                     .y(function(d) {
                        return yScale(d.effort_rank)
                     });

        // Create a line chart displaying the ranking of California over time
        let californiaData = data.filter(d => d.state == 'California');

        let linePlot = container.append('g')
                                .append('path')
                                .datum(californiaData)
                                .attr('class', 'chart3-line')
                                .attr('id', d => d.state)
                                .attr('d', line)
                                .attr('fill', 'none')
                                .attr('stroke', 'steelblue')
                                .attr("stroke-width", 3)
                                .attr("stroke-linejoin", "round")
                                .attr("stroke-linecap", "round")
                                .attr('stroke-dasharray', `4,15`)
                                // .attr('stroke-dasharray', `0,${len}`)
                                // .transition()
                                //     .duration(5000) // over the course of this duration, the line is drawn. I would like to get this to line up with the moving circle that indicates the ranking
                                //     .ease(d3.easeLinear)
                                //     .attr("stroke-dasharray", `${len},${len}`)
                                ;
        // Plotting a circle that will display the ranking of California over time
        container.select('.chart3-rankingcircle').remove();

        let stateRankingCircle = container.append('g')
                                          .selectAll('.chart3-rankingcircle')
                                          .data(californiaData);

        stateRankingCircle.exit().remove();

        stateRankingCircle.transition().attr('cx', d => {
                                       return xScale(new Date(d.year, 1, 1));
                                   })
                            .attr('cy', d => yScale(d.effort_rank))
                            .attr('r', 5)
                            .attr('fill', orange)
                            .attr('opacity', 0.70)

        stateRankingCircle.enter().append('circle')
                                   .attr('class', 'chart3-rankingcircle')
                                   .attr('id', d => 'chart3-circle-' + d.year)
                                   .attr('cx', d => {
                                       return xScale(new Date(d.year, 1, 1));
                                   })
                                   .attr('cy', d => yScale(d.effort_rank))
                                   .attr('r', 15)
                                   .attr('fill', orange)
                                   .attr('opacity', 1e-6)
    }

    let data = d3.csv("./data/merged_data.csv", function(d) {
        // Converting from String to Numeric types
        return {
            year: +d.Year,
            state: d.State,
            inflation_adj_exp_per_student: +d['Inflation Adjusted Total Spending'],
            students: +d['Num Students'],
            teachers: +d['Num Teachers'],
            pop: +d['Population'],
            personal_income: +d['Personal Income'],
            naep: +d['NAEP Scores'],
            inflation_adj_exp_per_student: +d['Inflation Adjusted Exp Per Student'],
            effort: +d['Effort'],
            effort_rank: +d['Effort Ranked'],
            alt_effort: +d['Alternative Effort'],
            alt_effort_rank: +d['Alternative Effort Ranked'],
        }
    }).then(function(data) {
        plotChart1(data);
        plotChart2(data);
        plotChart3(data);


    });
</script>
</html>